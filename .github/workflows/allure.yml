name: Tests with Allure Report
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14.2'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt allure-pytest

      - name: Run tests with Allure
        run: |
          pytest --alluredir=allure-results
        continue-on-error: true

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      #  Скачиваем артефакт 'allure-history' из ПРЕДЫДУЩЕГО выполнения
      - name: Download previous Allure results (History)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PREVIOUS_RUN_ID: ${{ github.run_id }}
        run: |
         # Вычисляем ID предыдущего запуска
          PREV=$(($PREVIOUS_RUN_ID - 1))
          echo "Attempting to download artifact 'allure-history' from previous run ID: $PREV"
         # Команда скачивает артефакт, если он существует (добавлено т.к. Github Actions не видел предыдущие результаты (артефакты)
          gh run download $PREV --name allure-history --dir allure-history 2>/dev/null || echo "Artifact 'allure-history' not found in run $PREV (this is OK for the first runs)."
        continue-on-error: true

      # Скачиваем историю из уже опубликованного сайта (ветка gh-pages)
      - name: Download previous history from gh-pages
        continue-on-error: true
        run: |
          git clone --depth 1 --branch gh-pages https://github.com/${{ github.repository }}.git gh-pages-temp 2>/dev/null || true
          if [ -d "gh-pages-temp/history" ]; then
            echo "Found existing history in gh-pages branch."
            mkdir -p allure-history
            cp -r gh-pages-temp/history/* allure-history/
          else
            echo "No existing history found in gh-pages (first run or history missing)."
          fi

      - name: Generate Allure report
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report
          # Копируем историю, если она была скачана
          if [ -d allure-history ] && [ "$(ls -A allure-history 2>/dev/null)" ]; then
            echo "Copying existing history into the new report..."
            cp -r allure-history/. allure-report/history/
          else
            echo "No previous history found. Starting fresh."
          fi

      - name: Upload Allure history for next run
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: allure-report/history
          retention-days: 30

      - name: Upload Allure report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
          retention-days: 30

      - name: Deploy Allure report to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
          # force_orphan: true # полностью очищает историю ветки