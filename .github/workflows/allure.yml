name: Tests with Allure Report
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14.2'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt allure-pytest

      - name: Run tests with Allure
        run: |
          pytest --alluredir=allure-results
        continue-on-error: true

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      # Скачиваем историю из уже опубликованного сайта (ветка gh-pages)
      - name: Download previous history from gh-pages
        continue-on-error: true
        run: |
          git clone --depth 1 --branch gh-pages https://github.com/${{ github.repository }}.git gh-pages-temp 2>/dev/null || true
          if [ -d "gh-pages-temp/history" ]; then
            echo "Found existing history in gh-pages branch."
            mkdir -p allure-history
            cp -r gh-pages-temp/history/* allure-history/
          else
            echo "No previous history found in gh-pages (first run or history missing)."
          fi

      - name: Check Docker availability
        run: docker --version

      - name: Generate Allure report
        run: |
          # Проверяем, что папки существуют
          mkdir -p allure-history allure-report
        
          # Генерируем отчёт через Docker
          docker run --rm \
            -v $(pwd)/allure-results:/allure-results \
            -v $(pwd)/allure-history:/allure-history \
            -v $(pwd)/allure-report:/allure-report \
            allure/allure:latest \
            generate --clean /allure-results --output /allure-report --history-dir /allure-history
        
          echo "Allure report generated with history via Docker."

      - name: Upload Allure history for next run
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: allure-report/history
          retention-days: 30

      - name: Upload Allure report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
          retention-days: 30

      - name: Deploy Allure report to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
